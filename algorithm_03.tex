\chapter{Garment Pick and Place Points}
\label{pick_and_place}
This chapter explains the last steps in our algorithm, in which we use the data obtained in the previous depth map clustering (chapter \ref{garment_clustering}) to determine the next unfold pick and place points for the humanoid robot.\juansays{(Referenciar figura)}

\begin{figure}[thpb]
    \centering
    \includegraphics[width=0.7
    \textwidth]{figures/placeholder2.png}
    \caption{\comment{(Block diagram for Garment Depth Map Clustering chapter)}}
    \label{fig:garment_pnp_points_blocks}
\end{figure}

\section{Candidate Unfold Paths}
\label{unfold_paths}

The next step in our algorithm is to create a set of paths from the highest point in the garment to the midpoint of each contour segment. This is the set of candidate unfold paths, based in the assumption that when a garment has an overlapping fold, the fold line will rest in the garment contour, and the folded surface with have lower depth values (i.e. closer to the depth sensor).

These paths are checked so that they are located entirely inside the garment, paths that go outside the garment contour are considered invalid. Figure \ref{fig:candidate_paths} shows both the initial path candidates set and the candidates set without the invalid paths.

\begin{figure}[thpb]
    \centering
    \includegraphics[width=0.7
    \textwidth]{figures/placeholder2.png}
    \caption{\comment{(Figure that shows both the initial path candidate set and the candidate set without the invalid paths)}}
    \label{fig:candidate_paths}
\end{figure}


To find the highest point in the garment, regions found with the watershed algorithm are first averaged using the median value for each region. Then, the region with the lowest depth value, which is closer to the camera and therefore higher in the garment, is selected. The centroid of the selected cluster is the point selected as highest point. Using these method instead of selecting directly the highest point from the depth image increases the robustness of the algorithm against outliers and noise present in the depth image.


\section{Bumpiness}
\label{bumpiness}

Each of the candidate paths calculated using the method explained in the previous section was then analized to determine the best unfolding path. The differences in height between the overlapping fold region and the rest of the clothing article are assumed to be greater that the diferences in height amongst the fold region points. Under that assumption, the metric to evaluate the best path was a \textit{bumpiness} value \textit{B}, calcutated by penalizing the changes in height of the candidate path as show in Eq \ref{eq:bumpiness}

\begin{equation}\label{eq:bumpiness}
B = \sum_{i=1}^{n} | \textrm{path}(i)- \textrm{path}(i-1) | 
\end{equation}

Where $n$ is the number of points composing the path. The path with the lowest bumpiness value, which corresponds to the path with the less and smallest height changes, is selected as the unfold direction, Fig. \ref{fig:paths_with_bumpiness}.

For performing the \textit{bumpiness} value calculation, the path was discretized  in constant-lenght segments, and the depth image was sampled at those discrete points. Then, equation \ref{eq:bumpiness} was applied to the sampled values.

\begin{figure}[thpb]
    \centering
    \includegraphics[width=\textwidth]{figures/candidate_paths.pdf}
    \caption{On the left side, the candidate paths are shown. On the right side, the height profile of each path is shown. Notice that the depth sensor computes the distance to the object from itself, so that a low value in the bar plot means a closer object to the sensor, so it is a region with more height with respect to the table.}
    \label{fig:paths_with_bumpiness}
\end{figure}

\section{Pick and Place Points}
\label{pick_and_place}
Once the most promising path for unfolding has been identified, the last step is to obtain pick and place points for the robot to perform the unfold action.

The most suitable grasping point for the picking action is located in the  intersection between the unfolding path direction line and the highest garment region border. This point is obtained by calculating the intersection between the selected path line and the highest region contour, selecting the point which is furthest to the garment border.

The other point is used as axis for a point reflection. To find the placing point, a reflection transformation is applied to the picking point using the aforementioned point as axis. Figure \ref{fig:directions} shows the unfold directions for several clothes, departing at the picking points and arriving to the placing points.

\begin{figure}[thpb]
    \centering
    \includegraphics[width=0.7\textwidth]{figures/directions.pdf}
    \caption{Final directions calculated for each garment provided to the system. Each arrow departs where the robot should pick the fold and arrives where it should be placed.}
    \label{fig:directions}
\end{figure}

\warning{Moved from old \ref{garment_PnP_points} to here}

\comment{On the labeled watershed image, we calculate the average height value of each region, and assign this average value to all points in the region. The region with the highest average height is selected for further analysis. }

\comment{The next step, after having labeled the similar-height regions and found the highest region, is to find the unfold direction. The assumption made here is that the fold has at least one contour edge which is also a border of the garment. }

\comment{A set of candidate paths is generated, all of them starting at the centroid of the highest region, and ending in each contour segment midpoint. Each candidate path is analyzed and assigned a value calculated by penalizing the changes in the height of the path.}

\comment{Up to here, we have detected the most promising direction to unfold. Finally, we need to define is the exact point where the robot has to pick the garment, and the place point. }

\comment{For this, we extend the previously selected direction line. The garment pick point is chosen at the intersection of the direction line with the inner region border. To find this point, we compute the intersection between the line and the region contour, and select the point furthest to the garment border. }

\comment{On the other side, the place point is selected by computing the symmetric point of the pick point with respect to the garment edge intersection point. The unfold directions, departing from the pick point and arriving at the place point of a set of clothes, is shown in Fig. \ref{fig:directions}. }